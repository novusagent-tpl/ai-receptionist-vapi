# AI-Receptionist-VAPI — CONTEXT (Single Source of Truth)
# Ultimo aggiornamento: 19 febbraio 2026

## Cos'è il progetto
AI Receptionist telefonica per ristoranti. Un cliente chiama il ristorante, risponde un'assistente AI che gestisce prenotazioni, orari, modifiche, cancellazioni, FAQ e handover verso il personale. Il sistema è multi-ristorante e multi-gestionale.

## Stack tecnico
- **Backend**: Node.js (Express) su Render
- **Piattaforma vocale**: Vapi (LLM + TTS + Transcriber + tool calling)
- **Gestionali supportati**: Google Sheets/Calendar, resOS, OctoTable
- **Timezone**: Europe/Rome (gestito con Luxon)
- **Principio**: backend = fonte di verità. L'AI non decide, il backend decide.

---

## Ristoranti configurati

| ID | Nome | Gestionale | Stato |
|----|------|-----------|-------|
| roma | Ristorante Roma (test) | Google Sheets/Calendar | Test V2.1 completati (22 test) |
| modena01 | Da Michele | resOS | Da testare con v2.2 |
| octodemo | OctoDemo (sandbox) | OctoTable | Da testare con v2.2 |

---

## Tools API (11 attivi su Vapi)

| Tool | Endpoint | Descrizione |
|------|----------|-------------|
| check_openings | /api/check_openings | Verifica apertura e disponibilità. Restituisce `message`, `day_label`, `time_human`, `nearest_slots_human`, `available`, `closed`, `reason`, `max_people`. Supporta `expected_weekday` per mismatch detection. |
| create_booking | /api/create_booking | Crea prenotazione. Verifica capacità server-side per Sheets. Restituisce `message`, `day_label`, `time_human`. |
| modify_booking | /api/modify_booking | Modifica prenotazione. Restituisce `message`, `day_label`, `time_human`. |
| cancel_booking | /api/cancel_booking | Cancella prenotazione. |
| list_bookings | /api/list_bookings | Lista prenotazioni future per telefono. Include `day_label`, `time_human` e `message` (formato parlato). Filtra canceled/deleted per resOS. |
| resolve_relative_day | /api/resolve_relative_day | Converte "domani", "sabato", ecc. in data ISO + `day_label`. |
| resolve_relative_time | /api/resolve_relative_time | Converte "tra 2 ore", "mezz'ora" in HH:MM. Accetta anche orari assoluti come fallback. Supporta "X e mezza", "X e un quarto". |
| is_open_now | /api/is_open_now | Verifica se il ristorante è aperto ora (per handover). |
| send_sms | /api/send_sms | Invio SMS di conferma. |
| end_call | — | Tool Vapi nativo per chiudere la chiamata. |
| transfer_call_tool_<id> | — | Tool Vapi nativo per trasferire al ristorante. Uno per ristorante. |

---

## Architettura backend — Decisioni chiave

### Backend rigido (message-first)
- Ogni tool restituisce un campo `message` con una frase italiana pronta per il cliente.
- L'AI usa `message` come base per la risposta. Non lo contraddice mai.
- Il payload Vapi contiene SOLO campi che l'AI deve leggere (message, day_label, time_human, nearest_slots_human, available, closed, reason, max_people). I campi raw (slots, lunch_range, dinner_range) sono solo nella risposta HTTP/Postman per debug.

### day_label (universale)
- Tutti i tool restituiscono `day_label` (es. "giovedì 19 febbraio").
- L'AI usa SEMPRE day_label per comunicare date. Mai calcolo autonomo da ISO.

### time_human / nearest_slots_human
- Orari in formato italiano parlato (es. "20 e 30" invece di "20:30").
- Evita problemi TTS (colon letto male, numeri in inglese).
- Presente in: check_openings, create_booking, modify_booking, list_bookings.

### expected_weekday (WEEKDAY_MISMATCH)
- Se il cliente dice un weekday, l'AI passa `expected_weekday` a check_openings.
- Il backend verifica che la data corrisponda al weekday.
- Se mismatch: restituisce `corrected_day` e `corrected_day_label` con il prossimo giorno corretto.
- L'AI richiama check_openings silenziosamente con la data corretta.

### Capacity engine (Sheets/Calendar)
- `max_concurrent_bookings` e `avg_stay_minutes` nel KB.
- check_openings: conta prenotazioni attive con overlap bidirezionale.
- create_booking per Sheets: verifica capacità server-side prima di scrivere (blocco anti-overbooking).
- Per resOS/OctoTable: l'API esterna gestisce la capacità.

### Cutoff prenotazioni
- `booking_cutoff_minutes` nel KB.
- Applicato solo alla prenotabilità (nearest_slots filtrati).
- NON altera gli orari informativi di apertura.

### Durata evento Calendar
- Usa `avg_stay_minutes` dal KB (non più hardcoded 2 ore).

### Filtro prenotazioni cancellate (resOS)
- list_bookings filtra status "canceled" e "deleted" da resOS.
- Solo prenotazioni "approved" vengono mostrate.

### Next open day
- Quando un giorno è chiuso, il backend cerca il prossimo giorno aperto (max 7 giorni) e lo include nel `message`.

### Logging corretto (v2.1)
- `create_booking`, `modify_booking`, `cancel_booking`: log `_success` solo se `result.ok === true`.
- Se `result.ok === false` (DUPLICATE_BOOKING, SLOT_FULL, BOOKING_NOT_FOUND, ecc.): log `_rejected` a livello `warn` con `error_code`.
- Le metriche su `/metrics` riflettono correttamente successi vs rifiuti.

---

## System Prompt — Versione attuale: v2.2

### File prompt
- `prompts/System-Prompt-ReceptionistV2.md` — Roma (Alice) v2.2
- `prompts/System-Prompt-Receptionist_modena01.md` — Modena01 (Giulia) v2.2
- `prompts/System-Prompt-Receptionist_octodemo.md` — OctoDemo (Sofia) v2.2
- `prompts/SYSTEM-PROMPT-base-18_02.md` — Backup v1.4 pre-pulizia (NON TOCCARE MAI)

### Struttura prompt (4 sezioni)
1. **CORE RULES** — Regole logiche infrangibili, divieti assoluti
2. **STATE MACHINE** — Flussi operativi (prenotazione, modifica, cancellazione, orari, FAQ, handover)
3. **TOOL CONTRACTS** — Quando e come usare ogni tool, prerequisiti, output
4. **VOICE & UX** — Tono, errori, fallback, esempi

### Differenze tra prompt
Solo 4 campi cambiano per ristorante:
- `restaurant_id` (roma / modena01 / octodemo)
- Nome receptionist (Alice / Giulia / Sofia)
- `transfer_call_tool_<id>`
- `is_open_now(restaurant_id="<id>")`

### Regole chiave nel prompt v2.2
- **CONSERVAZIONE DATI**: persone/nome/telefono non si perdono durante negoziazione slot
- **REGOLA MESSAGE**: usare il testo del campo `message` così com'è, non riformulare orari
- **REGOLA TIME_HUMAN**: usare `time_human` e `nearest_slots_human` per dire orari al cliente
- **REGOLA SALUTO INIZIALE**: prima risposta del cliente ("salve", "ciao") = apertura, NON chiusura → NON endCall
- **REGOLA DOPPIO SALUTO**: dopo saluto di chiusura dell'AI, se cliente dice "ciao" → endCall immediato

---

## Cosa è stato fatto (cronologia)

### Fase G21 — Backend Sheets robusto ✅
- Data integrity Sheets (scrittura deterministica, cancellazione riga)
- Cutoff pre-chiusura
- Error handling umano (PAST_TIME, PAST_DATE)
- Distinzione aperto vs prenotabile
- Orari ambigui (1-11 → chiedere mattina/sera)

### Fase G22 — Voice Stress Test ✅
- Hard stop check_openings/resolve_relative_time nel prompt
- Normalizzazione vocale orari
- Normalizzazione telefono E.164

### Integrazione resOS ✅
- CRUD prenotazioni via API resOS
- Filtro status canceled/deleted in list_bookings

### Integrazione OctoTable ✅
- CRUD prenotazioni via API OctoTable (sandbox)
- Error mapping OctoTable → codici errore standard

### Backend rigido — Refactor principale ✅
- Campo `message` in check_openings (frase pronta per ogni stato)
- `day_label` universale in tutti i tool
- `time_human` e `nearest_slots_human` per TTS corretto
- `expected_weekday` + WEEKDAY_MISMATCH in check_openings
- `next_open_day` quando chiuso
- reason="closed" fix (prima era "not_in_openings" anche quando chiuso)
- resolve_relative_time accetta orari assoluti come fallback
- Rimossi slots/lunch_range/dinner_range dal payload Vapi

### Sheets/Calendar come gestionale rigido ✅
- Capacity check server-side in create_booking per Sheets
- Durata evento Calendar dinamica (avg_stay_minutes)
- Modulo condiviso capacity-utils.js
- Validazione orario apertura in create_booking

### Pulizia prompt v2.0 ✅
- Da 237 righe a 211 righe (~11% meno)
- Unificate 3 regole weekday/day_label/mismatch in 1
- Rimossi riferimenti a lunch_range/dinner_range (non più nel payload Vapi)
- Eliminata sezione "Frasi per risposta check_openings" (ora usa message)
- Fix bug modena01: transfer_call_tool_roma → transfer_call_tool_modena01

### create_booking / modify_booking — Campi human ✅
- `time_human` e `message` di conferma in create_booking e modify_booking
- `day_label` in entrambi

### Test V2.0 + Fix v2.1/v2.2 ✅ (19 febbraio 2026)
- 15 test Vapi Roma con prompt v2.0: 12 PASS, 2 con difetti importanti, 1 PARZIALE
- Fix v2.1 backend: `list_bookings` → `formatTimeHuman` nel message e `time_human` per ogni booking
- Fix v2.1 backend: logging corretto in create/modify/cancel_booking (`_success` solo se ok, `_rejected` per errori business)
- Fix v2.1 prompt: CONSERVAZIONE DATI, REGOLA MESSAGE/TIME_HUMAN rinforzate, endCall doppio ciao
- Fix v2.2 prompt: REGOLA SALUTO INIZIALE (prima risposta cliente = apertura), REGOLA DOPPIO SALUTO riformulata
- 7 re-test V2.1: 7/7 PASS (4 puliti, 3 con difetto cosmetico AI riformula orari)
- Fix logging confermato: DUPLICATE_BOOKING ora logga `create_booking_rejected` ✅
- Fix CONSERVAZIONE DATI confermato: persone mantenute durante negoziazione slot ✅
- Fix endCall saluto iniziale confermato: "Salve" di apertura non chiude più la chiamata ✅

---

## Test — Stato attuale

### Regression tests backend (scripts/regression-tests.js) ✅
- 230/230 PASS (locale) per roma, modena01, octodemo
- Eseguiti il 19/02/2026 dopo fix logging

### Test Vapi Roma (Sheets/Calendar) ✅
- File: `docs/Test_Attivazione/test_vapi_roma_sheets_v2.md`
- **Test V2.0** (15 test): completati, 12 PASS + 2 con difetti importanti + 1 PARZIALE
- **Re-test V2.1** (7 test): completati, 7/7 PASS
- **Difetto residuo**: AI riformula orari dal message ("12 e 30" → "12.30") — comportamento del modello, TTS legge comunque in italiano. Non critico.

### Test Vapi Modena01 (resOS)
- Da fare: test rapidi post-v2.2 (5-6 test chiave)

### Test Vapi OctoDemo (OctoTable)
- Da fare: test rapidi post-v2.2 (5-6 test chiave)

---

## Configurazione KB (Knowledge Base)

Ogni ristorante ha un file JSON in `kb/` con:
- Orari di apertura per giorno (lunch/dinner ranges)
- `max_concurrent_bookings` — max prenotazioni contemporanee
- `avg_stay_minutes` — durata media prenotazione
- `booking_cutoff_minutes` — minuti prima della chiusura per non accettare prenotazioni
- `slot_step_minutes` — intervallo tra slot (default 30)
- `max_nearest_slots` — max alternative proposte (default 3)
- `max_people` — max persone per prenotazione online
- FAQ, indirizzo, contatti, policy

---

## Tool su Vapi — Configurazione

Per ogni assistente Vapi servono 11 tool:
- 10 tool condivisi (stessi per tutti gli assistenti)
- 1 tool `transfer_call_tool_<id>` specifico per ristorante

Il tool `faq` esiste nel backend ma non è usato su Vapi — le FAQ sono nella Knowledge Base di Vapi.

### Description tool su Vapi (importanti)
- **check_openings**: "Verifica disponibilità per un giorno e orario. Restituisce: message (frase pronta da usare), available, nearest_slots_human, max_people. Usare SEMPRE il campo message come base per la risposta."
- **end_call**: "Termina la chiamata immediatamente. Chiamare nella STESSA risposta in cui dai il saluto finale al cliente. Non aspettare che il cliente parli di nuovo. Usare solo quando la conversazione è conclusa."

---

## Prossimi passi

1. **Test rapidi Modena01** (5-6 test chiave con prompt v2.2)
2. **Test rapidi OctoDemo** (5-6 test chiave con prompt v2.2)
3. **H1 — Label fasce orarie personalizzabili** (per ristoranti con colazione/apertura continua)
4. **Onboarding primo ristorante reale**
5. **Aggiornare `ristoranti.json`** con `prompt_version: "v2.2"` per roma, modena01, octodemo
6. (Futuro) WhatsApp Business integration
7. (Futuro) Dashboard monitoraggio automatico
8. (Futuro) App gestionale staff (form web multi-ristorante per prenotazioni su Sheets)

---

## Deploy — Regole importanti

- **NON usiamo git per il deploy.** Tutto è in locale.
- Backend: upload manuale dei file su Render.
- Prompt: copia-incolla manuale su Vapi (system prompt di ogni assistente).
- Il file base `prompts/SYSTEM-PROMPT-base-18_02.md` NON va mai toccato.
- Il file `docs/System-Prompt-Receptionist.md` è il vecchio prompt v1 — NON toccarlo.
- Ogni modifica ai prompt deve essere applicata a TUTTI E 3 i ristoranti.

---

## File principali del progetto

### Backend
- `src/server-vapi.js` — Server Express, routing
- `src/api/check_openings.js` — Verifica apertura e disponibilità
- `src/api/create_booking.js` — Crea prenotazione (+ logging corretto v2.1)
- `src/api/modify_booking.js` — Modifica prenotazione (+ logging corretto v2.1)
- `src/api/cancel_booking.js` — Cancella prenotazione (+ logging corretto v2.1)
- `src/api/list_bookings.js` — Lista prenotazioni (+ formatTimeHuman v2.1)
- `src/api/resolve_relative_day.js` — Risolve giorni relativi
- `src/api/resolve_relative_time.js` — Risolve orari relativi
- `src/api/is_open_now.js` — Verifica apertura attuale
- `src/api/faq.js` — FAQ (non usato su Vapi)
- `src/api/send_sms.js` — Invio SMS
- `src/capacity-utils.js` — Funzioni condivise per capacità
- `src/reservations.js` — Router gestionali
- `src/reservations-sheets.js` — Integrazione Google Sheets/Calendar
- `src/reservations-resos.js` — Integrazione resOS
- `src/reservations-octotable.js` — Integrazione OctoTable
- `src/calendar.js` — Google Calendar
- `src/time-utils.js` — Utility orari/date
- `src/kb.js` — Lettura Knowledge Base
- `src/logger.js` — Logging strutturato
- `src/config/ristoranti.json` — Configurazione ristoranti

### KB
- `kb/roma.json` — KB Roma
- `kb/modena01.json` — KB Modena01
- `kb/octodemo.json` — KB OctoDemo

### Prompt
- `prompts/System-Prompt-ReceptionistV2.md` — Roma (v2.2)
- `prompts/System-Prompt-Receptionist_modena01.md` — Modena01 (v2.2)
- `prompts/System-Prompt-Receptionist_octodemo.md` — OctoDemo (v2.2)

### Test
- `scripts/regression-tests.js` — Test backend automatizzati (230 test)
- `docs/Test_Attivazione/test_vapi_roma_sheets_v2.md` — Test Vapi Roma (22 test)

### Docs
- `docs/ROADMAP-SAAS.md` — Roadmap completa del progetto
- `docs/TOOLS-CONTRACT.md` — Contratti API di ogni tool
- `docs/CONTEXT.txt` — Questo file
